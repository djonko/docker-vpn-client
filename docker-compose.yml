services:
  openvpn-client:
    build:
      context: ./build
    container_name: openvpn-client
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      TZ: ${TZ}
      SUBNETS: ${MY_SUBNETS}
      HTTP_PROXY: on
      HTTP_PROXY_USERNAME_SECRET: proxy_username
      HTTP_PROXY_PASSWORD_SECRET: proxy_password
      SOCKS_LISTEN_ON: ${MY_SOCKS_LISTEN_ON}
      VPN_LOG_LEVEL: 1
    volumes:
      - /opt/data-docker/volumes/openvpn-client:/data/vpn
    ports:
      - 8778:8080
      - 8779:1080
    secrets:
      - proxy_username
      - proxy_password
  socks5:
    restart: unless-stopped
    image: serjs/go-socks5-proxy
    environment:
      TZ: ${TZ}
    ports:
      - "8779:1080"
    network_mode: "service:openvpn-client"

secrets:
  proxy_username:
    file: /opt/data-etc/openvpn-client/proxy_username.txt
  proxy_password:
    file: /opt/data-etc/openvpn-client/proxy_password.txt
  proxy_sock_username:
    file: /opt/data-etc/openvpn-client/proxy_username.txt
  proxy_sock_password:
    file: /opt/data-etc/openvpn-client/proxy_password.txt